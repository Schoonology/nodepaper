#!/usr/bin/env node
var lib = require('../lib')
  , middleware = require('../middleware')
  , rc = lib('rc')
  , http = require('http')
  , path = require('path')
  , express = require('express')
  , app = express()

app
  .use(express.favicon()) // TODO: Provide.
  .use(express.logger())
  .use(express.cookieParser())
  .use(express.bodyParser())
  .use(express.query())
  .use(app.router)
  // TODO: Cache.
  .use('/static', express.static(path.resolve(__dirname, '..', rc.paths.static)))
  .use('/editor', function (req, res, next) {
    res.sendfile(path.resolve(__dirname, '..', rc.paths.static, 'editor', 'index.html'))
  })
  .use('/', function (req, res, next) {
    res.sendfile(path.resolve(__dirname, '..', rc.paths.static, 'index.html'))
  })
  .use(express.errorHandler())

http.createServer(app).listen(rc.port, function (err) {
  if (err) {
    console.error(err.stack || err.message || err)
    process.exit(1)
  } else {
    console.info('Listening on port ' + rc.port + '...')
  }
})

//
// ## Routes
//
app.put('/api/*', middleware('validateSecret'))
app.del('/api/*', middleware('validateSecret'))
app.all('/api/ping', middleware('ping'))

app.get('/api/articles', middleware('findResource')(lib('article')))
app.get('/api/articles/:name', middleware('getResource')(lib('article')))
app.put('/api/articles/:name', middleware('putResource')(lib('article')))

app.get('/api/pages', middleware('findResource')(lib('page')))
app.get('/api/pages/:name', middleware('getResource')(lib('page')))
app.put('/api/pages/:name', middleware('putResource')(lib('page')))
app.del('/api/pages/:name', middleware('delResource')(lib('page')))

// app.get('/api/authors', middleware('findResource')(lib('author')))
// app.get('/api/authors/:name', middleware('getResource')(lib('author')))
// app.put('/api/authors/:name', middleware('putResource')(lib('author')))

// app.get('/api/media', middleware('findResource')(lib('media')))
// app.get('/api/media/:name', middleware('getResource')(lib('media')))
// app.put('/api/media/:name', middleware('putResource')(lib('media')))
