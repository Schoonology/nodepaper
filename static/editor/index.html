<!doctype html>
<html ng-app="nodepaper">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Nodepaper Editor</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/codemirror.css" rel="stylesheet">
    <link href="/css/codemirror/monokai.css" rel="stylesheet">
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">Nodepaper Editor</a>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="span12">
        </div>
      </div>
      <div class="row">
        <div class="span3">
          <ul class="nav nav-list" ng-controller="PageNavController" np-active>
            <li class="nav-header">Pages</li>
            <li ng-repeat="page in pages"><a ng-href="#/pages/{{page}}" ng-bind="page"></a></li>
          </ul>
        </div>
        <div class="span9">
          <div ng-view></div>
        </div>
      </div>
    </div>
    <!-- <div ng-view></div> -->

    <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script> -->
    <script>window.jQuery || document.write('<script src="/js/lib/jquery.js"><\/script>')</script>
    <!-- <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.js"></script> -->
    <script>window.angular || document.write('<script src="/js/lib/angular.js"><\/script>')</script>
    <script src="/js/lib/bootstrap.min.js"></script>
    <script src="/js/lib/codemirror.js"></script>
    <script src="/js/lib/codemirror/javascript.js"></script>
    <script src="/js/lib/codemirror/xml.js"></script>
    <script src="/js/lib/codemirror/css.js"></script>
    <script src="/js/lib/codemirror/htmlmixed.js"></script>
    <script src="/js/lib/codemirror/edit/closetag.js"></script>
    <script src="/js/directive.codemirror.js"></script>
    <script src="/js/directives.js"></script>
    <script src="/js/services.js"></script>
    <!-- <script src="/js/lib/lawnchair.js"></script> -->
    <!-- <script src="/js/lib/moment.js"></script> -->
    <!-- <script src="/js/lib/jqconsole.min.js"></script> -->
    <!-- <script src="/js/cushion.js"></script> -->
    <script src="/js/lib/md5.js"></script>
    <script>
      angular
        .module('nodepaper', ['codemirror', 'nodepaper.services', 'nodepaper.directives'])
        .config(function ($routeProvider) {
          $routeProvider
      //       .when('/articles/:name', {
      //         template: '<div template="content"></div>',
      //         controller: ArticleController
      //       })
            .when('/pages/:name', {
              templateUrl: '/partials/page.editor.html',
              controller: PageEditorController
            })
      //       .when('/authors/:name', {
      //         template: '<div template="content"></div>',
      //         controller: AuthorController
      //       })
            .otherwise({
              redirectTo: '/'
            })
        })
      //   .directive('template', function ($compile) {
      //     return function template(scope, element, attrs) {
      //       scope.$watch(
      //         function (scope) {
      //           return scope.$eval(attrs.template)
      //         },
      //         function (value) {
      //           element.html(value)

      //           $compile(element.contents())(scope)
      //         }
      //       )
      //     }
      //   })
      function PageNavController($scope, $location, Page) {
        $scope.pages = []

        Page
          .find()
          .then(function (list) {
            $scope.pages = list
          })
      }

      function ArticleController($scope, $route, $compile, Article) {
        var name = $route.current.params.name

        Article
          .load(name)
          .then(function (data) {
            Object.keys(data).forEach(function (key) {
              $scope[key] = data[key]
            })
          })
      }

      function AuthorController($scope, $route, $compile, Author) {
        var name = $route.current.params.name

        Author
          .load(name)
          .then(function (data) {
            Object.keys(data).forEach(function (key) {
              $scope[key] = data[key]
            })
          })
      }

      function PageController($scope, $route, $compile, Page) {
        // TODO: Load only if meta and content aren't already present (i.e. we're nested in another Controller.)

        return

        var name = $route.current.params.name

        Page
          .load(name)
          .then(function (data) {
            Object.keys(data).forEach(function (key) {
              $scope[key] = data[key]
            })
          })
      }

      function PageEditorController($scope, $route, $compile, Page) {
        var name = $route.current.params.name

        $scope.previewTemplateUrl = '/partials/page.html'
        $scope.meta = {}
        $scope.content = ''

        $scope.save = function () {
          var body = {
            meta: $scope.meta,
            content: $scope.content
          }

          Page
            .save(name, body)
            .then(function (data) {
              console.log('Saved:', data)
            })
        }

        Page
          .load(name)
          .then(function (data) {
            $scope.content = data.content
            $scope.meta = data.meta
          })
      }
    </script>
  </body>
</html>
